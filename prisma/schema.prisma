generator client {
  provider = "prisma-client"
  output   = "../src/@types/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model AuthenticationAudit {
  id         Int                      @id @default(autoincrement())
  ipAddress  String?                  @map("ip_address") @db.Inet
  remotePort String?                  @map("remote_port")
  userAgent  String?                  @map("user_agent")
  origin     String?
  status     AuthenticationStatusType
  createdAt  DateTime                 @default(now()) @map("created_at") @db.Timestamptz(3)

  userId Int?  @map("user_id")
  user   User? @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([userId, createdAt], name: "idx_auth_audit_user_date")
  @@map("authentication_audit")
}

model User {
  id                Int          @id @default(autoincrement())
  publicId          String       @unique @default(uuid(7)) @map("public_id")
  name              String
  birthdate         DateTime     @db.Date
  username          String       @unique
  email             String       @unique
  cpf               String       @unique
  passwordHash      String       @map("password_hash")
  loginAttempts     Int          @default(0) @map("login_attempts")
  lastLogin         DateTime?    @map("last_login") @db.Timestamptz(3)
  role              UserRoleType @default(DEFAULT)
  token             String?      @unique
  tokenExpiresAt    DateTime?    @map("token_expires_at") @db.Timestamptz(3)
  passwordChangedAt DateTime?    @map("password_changed_at") @db.Timestamptz(3)
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt         DateTime     @updatedAt @map("updated_at") @db.Timestamptz(3)

  authenticationAudits AuthenticationAudit[] @relation()

  @@index([name], name: "idx_user_name")
  @@index([token], name: "idx_user_token")
  @@map("users")
}

enum AuthenticationStatusType {
  SUCCESS
  USER_NOT_EXISTS
  INCORRECT_PASSWORD
  RECOVER_PASSWORD
  INVALID_TOKEN
  BLOCKED
}

enum UserRoleType {
  ADMIN
  DEFAULT
}
